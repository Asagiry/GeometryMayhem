name: Check

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install gdtoolkit
        run: pip install gdtoolkit

      - name: Auto-format GDScript
        run: |
          # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ .gd —Ñ–∞–π–ª—ã
          files_to_format=$(git ls-files '*.gd')
          if [[ -z "$files_to_format" ]]; then
            echo "‚úÖ No GDScript files found."
          else
            gdformat $files_to_format
            if [[ $(git status --porcelain) ]]; then
              echo "üîß Formatting changes detected. Committing..."
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add $files_to_format
              git commit -m "Auto-format GDScript code"
              # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É PR –∏–ª–∏ push
              branch_name=${GITHUB_HEAD_REF:-$(git rev-parse --abbrev-ref HEAD)}
              git push origin HEAD:$branch_name
              echo "üìå Changes pushed to branch '$branch_name'."
            else
              echo "‚úÖ No formatting changes needed."
            fi
          fi

      - name: Run gdlint
        run: gdlint .
